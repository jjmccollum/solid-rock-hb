\startenvironment sr-style
	%Draft-only options:
	%\showframe
	%\showgrid
	
	%Setup the page trim size and printing options:
	\definepapersize[10-by-8][width=8in,height=10in]
	\setuppapersize[10-by-8][10-by-8]
	\setuparranging [mirrored] %mirrored layout for double-sided printing
	\setuppagenumbering[alternative=doublesided,location=] %undo default page numbering in middle of header; doublesided option will ensure that the document has an even number of pages
	%Setup the page layout:
	\setuplayout[
		width=6in, %textblock width
		height=8.75in, %texblock height (7.5in) + header height + footer height
		backspace=1in, %spine margin
		topspace=0.5in, %head margin - header height
		header=0.75in, %header height
		footer=0.5in, %footer height
		grid=yes %enable baseline grid
	]
	
	%Patch pagecolumns so that it does not add a blank page:
	\unprotect
	\def\page_col_stop_yes
	  {%Add a column only if this is not the last column on the page:
	   \ifnum\c_page_col_current<\c_page_col_n_of_columns
	      \column
	   \fi
	   \page
	   \endgroup
	   % \setupoutputroutine[\s!singlecolumn]%
	   \page_otr_command_set_vsize
	   \page_otr_command_set_hsize
	   \page
	   \endgroup}
	\protect
	
	%Setup the columns layout:
	\definepagecolumns [hebrew] [
		n=2, %number of columns
		distance=0.375in, %space between columns
		direction=reverse, %ordering of columns (change to reverse for RTL languages)
		setups=hebrew:align
	]
	
	%\definepagecolumns doesn't appear to support an align option, so use this instead:
	\startsetups[hebrew:align]
		\setupalign[r2l,flushleft,nothyphenated] %alignment of text in columns (flush-left actually means flush-right, perhaps because of r2l?)
	\stopsetups
	
	%Setup English text font:
	\definefontfeature[f:oldstyle][onum=yes] %old-style numbers
	\definefontfeature[f:lining][lnum=yes] %lining (uniform-width) numbers
	\definefontfeature[f:superscript][sups=yes] %superscript
	\definefontfamily[english] [rm] [EB Garamond] [features={default,f:oldstyle,f:lining},protrusion=quality] %protrusion allows small punctuation characters to be set just past the boundary of justified text
	%Setup English title font:
	\definefontfamily[englishtitle] [rm] [EB Garamond] [features={kern=no}]
	%Setup Hebrew text font:
	\definefontfamily[hebrew] [rm] [Keter YG] [features=hebrew]
	%Setup Hebrew header font:
	\definefontfamily[hebrewheader] [rm] [Keter YG] [features={hebrew,kern=no}]
	%Setup Hebrew title font:
	\definefontfamily[hebrewtitle] [rm] [Keter Aram Tsova] [features={hebrew,kern=no}]
	%Setup apparatus font:
	\definefontfamily[apparatus] [rm] [Apparatus SIL] [features=default]
	
	%Define a macro that uses the actual superscript font feature:
	\define[1]\textsuperscript{{\feature[+][f:superscript]#1}}
	
	%Setup font size scaling macros:
	\definebodyfontenvironment [13pt] [d=26pt] %define rescaling for titles
	
	%Setup font kerning macros:
	\definecharacterkerning [titlekerning] [factor=1.0]
	\definecharacterkerning [headerkerning] [factor=.3333]
	
	%Setup font size and leading for text:
	\setupinterlinespace[18bp] %text line spacing
	\setupbodyfont[hebrew,13pt] %text font size
	
	%Setup font size and leading for footnotes:
	\startsetups[footnotesetup]
		\setupinterlinespace[12bp] %footnote line spacing
		\setupbodyfont[hebrew,10pt] %footnote font size
		\setupalign[r2l,flushleft,nothyphenated] %alignment of text in columns (flush-left actually means flush-right, perhaps because the column order is reversed?)
	\stopsetups
	
	%Setup layout of footnote text blocks:
	\setupnote[footnote][
		rule=off, %disable line separating footnotes from text
		before={\blank[18bp]}, %enforce one line of blank space between the text and the footnote block
		textcommand=\textsuperscript, %command for typesetting the footnote number in the main text
		setups=footnotesetup %setup for footnote font, leading, and alignment
	]
	%Setup formatting of footnote mark at bottom of text:
	\setupnotation[footnote][
		alternative=left, %align footnote symbol with edge of text (use right for RTL)
		hang=fit, %multi-line footnotes are not indented
		numbercommand=\textsuperscript %command for typesetting the footnote number in the footnote block
	]
	
	%Setup a parent class of footnotes for all apparatus entries:
	\definenote[app]
	\setupnote[app][
		rule=off, %disable line separating the apparatus from the text
		before={\blank[18bp]}, %enforce one line of blank space between the text and the apparatus
		textcommand=, %disable the default notation for the footnote symbol in the text; this will redefined for each footnote
		setups=footnotesetup %setup for footnote font, leading, and alignment
	]
	\setupnotation[app][
		numbercommand=, %disable the default notation for the footnote number; this will redefined for each footnote
		counter=, %disable the default counter for the footnote number; this will redefined for each footnote
		alternative=left, %align footnote symbol with edge of text (use right for RTL)
		hang=fit, %multi-line footnotes are not indented
	]
	
	%Define a variable containing the current chapter-verse reference covered in the apparatus:
	\setevariables[app][chapter=0,verse=0]
	
	%Define macro for adding a chapter-verse reference in the apparatus if it differs from the last chapter-verse reference in the apparatus:
	\define\SetAppRef{
		%Check if the current chapter reference matches the most recent chapter reference in the apparatus:
		\doifelse{\getvariable{text}{chapter}}{\getvariable{app}{chapter}}{%
			%If it does, then check if the verse reference matches:
			\doifelse{\getvariable{text}{verse}}{\getvariable{app}{verse}}{%
				%If it does, then do nothing:
				\nospace%
			}{%
				%If it does not, then update the latest verse reference and typeset the reference:
				\setxvariables[app][verse=\getvariable{text}{verse}]%
				{\switchtobodyfont[english, 9pt]\textdir TLT{\bf\getvariable{text}{chapter}\,:\,\getvariable{text}{verse}}}\nobreak\hspace[medium]%
			}%
		}{%
			%If it does not, then update the latest chapter and verse references and typeset the reference:
			\setxvariables[app][chapter=\getvariable{text}{chapter},verse=\getvariable{text}{verse}]%
			{\switchtobodyfont[english, 9pt]\textdir TLT{\bf\getvariable{text}{chapter}\,:\,\getvariable{text}{verse}}}\nobreak\hspace[medium]%
		}%
	}
	
	%Define counters for different variation types:
	\definecounter[sub]
	\definecounter[add]
	\definecounter[omit]
	\definecounter[trans]
	\setcounter[sub] [0] %use \setnumber if this doesn't work
	\setcounter[add] [0]
	\setcounter[omit] [0]
	\setcounter[trans] [0]
	
	%Define macros for typesetting apparatus marks:
	\define[1]\StartSubMark{{\switchtobodyfont[apparatus]⸃}\doifnot{#1}{1}{{\switchtobodyfont[english]\textsuperscript{#1}}}} %reverse symbol for RTL
	\define\StopSubMark{{\switchtobodyfont[apparatus]⸂}} %reverse symbol for RTL
	\define[1]\AddMark{{\switchtobodyfont[apparatus]⸆}\doifnot{#1}{1}{{\switchtobodyfont[english]\textsuperscript{#1}}}}
	\define[1]\StartOmitMark{{\switchtobodyfont[apparatus]⸋}\doifnot{#1}{1}{{\switchtobodyfont[english]\textsuperscript{#1}}}}
	\define\StopOmitMark{{\switchtobodyfont[apparatus]⸌}} %should reverse symbol for RTL, but Apparatus SIL doesn't include U2E0D
	\define[1]\StartTransMark{{\switchtobodyfont[apparatus]⸊}\doifnot{#1}{1}{{\switchtobodyfont[english]\textsuperscript{#1}}}} %reverse symbol for RTL
	\define\StopTransMark{{\switchtobodyfont[apparatus]⸉}} %reverse symbol for RTL
	
	%Define macros for apparatus entries:
	\define[2]\Reading{ %arg 1 is reading text, arg 2 is witness list
		\doifemptyelse{#1}{%
			{\switchtobodyfont[english, 9pt]\textdir TLT –}\nospace\nobreak\hspace[medium]{\switchtobodyfont[english, 9pt]\textdir TLT#2}\nobreak\hspace[medium]%represent the omission with an en-dash 
		}{%
			{\switchtobodyfont[hebrew, 10pt]\textdir TRT#1}\nospace\nobreak\hspace[medium]{\switchtobodyfont[english, 9pt]\textdir TLT#2}\nobreak\hspace[medium]%set the reading in Hebrew
		}%
	} 
	\define\PrimaryReadingSep{{\switchtobodyfont[english, 9pt][}\nobreak\,} %reverse symbol for RTL
	\define\SecondaryReadingSep{{\switchtobodyfont[english, 9pt]¦}\nobreak\,}
	
	%Define a macro for typesetting an apparatus:
	\define[3]\App{% arg 1 is the type of variation, arg 2 is the lemma text, arg 3 is the variant readings
		%Define the footnote symbol based on the type:
		\doif{#1}{substitution}{%
			%Update the counter:
			\incrementcounter[sub]%
			%Typeset the marking in the text:
			\StartSubMark{\rawcountervalue[sub]}\nobreak\,%
			%Then start the apparatus note:
			\startapp%
				%Typeset the marking in the apparatus, preceded by the chapter-verse reference, if needed, and followed by the variant readings:
				\SetAppRef\StartSubMark{\rawcountervalue[sub]}\nobreak\,#3%
			\stopapp%
			%Typeset the lemma in the text, followed by the closing substitution mark:
			#2\nobreak\,\StopSubMark%
		}%
		\doif{#1}{vocalic substantive}{%
			%Update the counter:
			\incrementcounter[sub]%
			%Typeset the marking in the text:
			\StartSubMark{\rawcountervalue[sub]}\nobreak\,%
			%Then start the apparatus note:
			\startapp%
				%Typeset the marking in the apparatus, preceded by the chapter-verse reference, if needed, and followed by the variant readings:
				\SetAppRef\StartSubMark{\rawcountervalue[sub]}\nobreak\,#3%
			\stopapp%
			%Typeset the lemma in the text, followed by the closing substitution mark:
			#2\nobreak\,\StopSubMark%
		}%
		\doif{#1}{addition}{%
			%Update the counter:
			\incrementcounter[add]%
			%Typeset the marking in the text:
			\AddMark{\rawcountervalue[add]}\nobreak\,%
			%Then start the apparatus note:
			\startapp%
				%Typeset the marking in the apparatus, preceded by the chapter-verse reference, if needed, and followed by the variant readings:
				\SetAppRef\AddMark{\rawcountervalue[add]}\nobreak\,#3%
			\stopapp%
		}%
		\doif{#1}{omission}{%
			%Update the counter:
			\incrementcounter[omit]%
			%Typeset the marking in the text:
			\StartOmitMark{\rawcountervalue[omit]}\nobreak\,%
			\startapp%
				%Typeset the marking in the apparatus, preceded by the chapter-verse reference, if needed, and followed by the variant readings:
				\SetAppRef\StartOmitMark{\rawcountervalue[omit]}\nobreak\,#3%
			\stopapp%
			%Typeset the lemma in the text, followed by the closing substitution mark:
			#2\nobreak\,\StopOmitMark%
		}%
		\doif{#1}{transposition}{%
			%Update the counter:
			\incrementcounter[trans]%
			%Typeset the marking in the text:
			\StartTransMark{\rawcountervalue[trans]}\nobreak\,%
			%Then start the apparatus note:
			\startapp%
				%Typeset the marking in the apparatus, preceded by the chapter-verse reference, if needed, and followed by the variant readings:
				\SetAppRef\StartTransMark{\rawcountervalue[trans]}\nobreak\,#3%
			\stopapp%
			%Typeset the lemma in the text, followed by the closing substitution mark:
			#2\nobreak\,\StopTransMark%
		}%
	}
	
	%Define custom book, chapter, and verse markings to be used in the header:
	\definemarking[Book]
	\definemarking[Chapter]
	\definemarking[Verse]
	
	%Define custom book, chapter, and verse variables to be used in the apparatus:
	\setxvariables[text][book=,chapter=,verse=]
	
	%Define macro for starting a new Book:
	\define[1]\Book{%
		%Add an entry to the table of contents at the chapter level:
		%TODO
		%Update the title of this Book:
		\setxvariables[text][book=#1,chapter=1,verse=1]%
	}
	
	%Define macro for an incipit:
	\define[1]\Incipit{%
		{%Temporarily clear all headers and footers and change text formatting:
		\setupheadertexts[][][][]%
		\setupfootertexts[][][][]%
		\setupinterlinespace[36bp]%text line spacing
		\page[odd]%page break to next odd page
		\startalignment[flushright]%switch to flush-right alignment
			{\switchtobodyfont[hebrewtitle]\setcharacterkerning[titlekerning]\textdir TRT\tfd#1}%text
		\stopalignment%
		\page[odd]%page break to next odd page
		}%
	}
	
	%Define macro for starting a new Chapter:
	\define[1]\Chapter{%
		%Update the chapter title and reset the verse title (the chapter will be typeset when the verse is):
		\setxvariables[text][chapter=#1,verse=0]%
		\marking[Chapter]{#1}%
	}
	%Define macro for marking a new Chapter in a variant reading (the chapter will be typeset when the verse is):
	\define[1]\RdgChapter{%
		%Update the chapter title and reset the verse title:
		\setxvariables[rdg][chapter=#1,verse=0]%
	}
	
	%Define macro for starting a new Verse:
	\define[1]\Verse{%
		%Check if the verse variable has been reset:
		\doifelse{\getvariable{text}{verse}}{0}{%
			%If it has, then typeset both the chapter and the verse:
			\nospace\hspace[medium]\marking[Verse]{#1}{\switchtobodyfont[english, 11pt]\textdir TLT\bf \getvariable{text}{chapter}\nobreak\,:\nobreak\,#1}\nobreak\hspace[medium]%
		}{%
			%Otherwise, just typeset the verse:
			\nospace\hspace[medium]\marking[Verse]{#1}{\switchtobodyfont[english, 11pt]\textdir TLT\bf #1}\nobreak\hspace[medium]%
		}%
		%Update the verse variable:
		\setxvariables[text][verse=#1]%
		%Reset the textual variation type counters:
		\setcounter[sub][0]%
		\setcounter[add][0]%
		\setcounter[omit][0]%
		\setcounter[trans][0]%
	}
	%Define macro for marking a new Verse in a variant reading:
	\define[1]\RdgVerse{%
		%Check if the verse variable has been reset:
		\doifelse{\getvariable{rdg}{verse}}{0}{%
			%If it has, then typeset both the chapter and the verse:
			\nospace\hspace[medium]{\switchtobodyfont[english, 9pt]\textdir TLT\bf \getvariable{rdg}{chapter}\nobreak\,:\nobreak\,#1}\nobreak\hspace[medium]%
		}{%
			%Otherwise, just typeset the verse:
			\nospace\hspace[medium]\marking[Verse]{#1}{\switchtobodyfont[english, 9pt]\textdir TLT\bf #1}\nobreak\hspace[medium]%
		}%
		%Update the verse variable:
		\setxvariables[rdg][verse=#1]%
	}
	%Define macro for closed section break:
	\definehspace[closedsectionspace][3em]
	\define\ClosedSectionSymbol{ס}
	\define\ClosedSection{%
		\nospace\hspace[none]\phantom{\hspace[closedsectionspace]}\nobreak%eat up any preceding space, add a space of zero width (to allow this to break from the preceding word), and then add a long non-breaking space
	}
	%Define macro for closed section break in a variant reading:
	\define\RdgClosedSection{%
		%{\switchtobodyfont[english, 9pt]\textdir TLT\{{\switchtobodyfont[hebrew, 10pt]\ClosedSectionSymbol}\}}%add a bracketed representation of the break
	}
	%Define macro for open section break:
	\define\OpenSectionSymbol{פ}
	\define\OpenSection{%
		\endgraf%end previous paragraph
		\blank[halfline,samepage]%non-breaking to ensure that no column begins with the open section symbol followed by a half line
		\startalignment[middle]׆\stopalignment%
		\blank[halfline,preference]%this can (and, if possible, should) be broken across a column
		\par%begin new paragraph
	}
	%Define macro for open section break in a variant reading:
	\define\RdgOpenSection{%
		%{\switchtobodyfont[english, 9pt]\textdir TLT\{{\switchtobodyfont[hebrew, 10pt]\OpenSectionSymbol}\}}%add a bracketed representation of the break
	}
	%Define macro for getting a reference range:
	\define\RefRange{%
		%Check if the first chapter matches the last chapter on the page:
		\doifsamestringelse{\fetchmarking[Chapter][1][top]}{\fetchmarking[Chapter][2][bottom]}{%
			%If the chapters match, then check if the first verse matches the last verse on the page:
			\doifsamestringelse{\fetchmarking[Verse][1][top]}{\fetchmarking[Verse][2][bottom]}{%
				%If the verses match, then the page consists of a single verse; use its reference:
				\getmarking[Chapter][1][top]\,:\,\getmarking[Verse][1][top]%
			}{%
				%If the verses do not match, then use one chapter and the verse range:
				\getmarking[Chapter][1][top]\,:\,\getmarking[Verse][1][top]\,--\,\getmarking[Verse][2][bottom]%
			}%
		}{%
			%If the chapters do not match, then use the entire reference range:
			\getmarking[Chapter][1][top]\,:\,\getmarking[Verse][1][top]\,--\,\getmarking[Chapter][2][bottom]\,:\,\getmarking[Verse][2][bottom]%
		}%
	}
	
	%Define lua function to replace single spaces with en spaces:
	\startluacode
		userdata = userdata or {}
	
		function userdata.replaceHeaderSpaces(str)
			local rep = {
				[1] = { " ", " "   },
			}
			context(lpeg.replacer(rep):match(str))
		end
	\stopluacode
	%Define a macro that uses this function:
	\define[1]\ReplaceHeaderSpaces{\ctxlua{userdata.replaceHeaderSpaces([==[#1]==])}}
	
	%Setup header and footer text:
	\setupheadertexts[\rlap{\switchtobodyfont[english, 11pt]\textdir TLT\RefRange}\hfill {\switchtobodyfont[hebrew, 13pt]\kerncharacters[0.25]\textdir TRT\ReplaceHeaderSpaces{\getvariable{text}{book}}} \hfill][][][\hfill {\switchtobodyfont[hebrew, 13pt]\kerncharacters[0.25]\textdir TRT\ReplaceHeaderSpaces{\getvariable{text}{book}}} \hfill \llap{\switchtobodyfont[english, 11pt]\textdir TLT\RefRange}] %even left, even right, odd left, odd right
	\setupfootertexts[{\switchtobodyfont[english, 11pt]\textdir TLT\pagenumber}][][][{\switchtobodyfont[english, 11pt]\textdir TLT\pagenumber}] %even left, even right, odd left, odd right
	
	%Ensure that whitespace respects the grid layout:
	\setupblank[line,fixed]
	
	%%%%%%%%%%%
	% Essay Settings
	%%%%%%%%%%%
	
	%Define macro for an essay title:
	\define[1]\Essay{%
		{%Temporarily clear all headers and footers and change text formatting:
		\setupheadertexts[][][][]%
		\setupfootertexts[][][][]%
		\setupinterlinespace[36bp]%text line spacing
		\page[odd]%page break to next odd page
		\startalignment[flushleft]%switch to flush-left alignment
			{\switchtobodyfont[englishtitle]\setcharacterkerning[titlekerning]\textdir TLT\tfd#1}%text
		\stopalignment%
		\page[odd]%page break to next odd page
		}%
	}

	
	
\stopenvironment