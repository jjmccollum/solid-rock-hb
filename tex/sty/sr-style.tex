\startenvironment sr-style % Solid Rock Hebrew Bible style environment
	%%%%%%%%%
	%DRAFT OPTIONS
	%%%%%%%%%
	
%	\showframe
%	\showgrid
	
	%%%%%%%%%
	% PAGE LAYOUT
	%%%%%%%%%
	
	%Setup the page trim size and printing options:
	\definepapersize[10-by-8][width=8in,height=10in]
	\setuppapersize[10-by-8][10-by-8]
	\setuparranging[mirrored] %mirrored layout for double-sided printing
	
	%Setup orphan and widow penalties for the gird (to discourage isolated paragraph lines at the top and bottom of pages):
%	\startsetups[grid][mypenalties]
%		\setdefaultpenalties
%		\setpenalties\widowpenalties{2}{10000}
%		\setpenalties\clubpenalties {2}{10000}
%	\stopsetups
	
	%Setup the page layout:
	\setuplayout[
		width=6in, %textblock width
		height=8.75in, %texblock height (7.5in) + header height + footer height
		backspace=1in, %spine margin
		topspace=0.5in, %head margin - header height
		header=0.75in, %header height
		footer=0.5in, %footer height
		grid=yes, %enable baseline grid
%		setups=mypenalties %discourage orphans and widows
	]
	
	%Setup page numbering:
	\setuppagenumbering[
		alternative=doublesided, %ensure that the document has an even number of pages
		location={footer, atmargin}, %place page number in footer along edge margin
	]
	
	%Define page number conversions for different divisions of the book
	\definestructureconversionset[frontpart:pagenumber][][romannumerals]
	\definestructureconversionset[bodypart:pagenumber][][numbers]
	\definestructureconversionset[backpart:pagenumber][][numbers]
	
	%Define an odd page break between books that omits headers and footers in blank pages
	\definepagebreak[blankpagebreak][yes,header,footer,odd]
	
	%Patch pagecolumns so that it does not add a blank page:
	\unprotect
	\def\page_col_stop_yes
	  {%Add a column only if this is not the last column on the page:
	   \ifnum\c_page_col_current<\c_page_col_n_of_columns
	      \column
	   \fi
	   \page
	   \endgroup
	 % \setupoutputroutine[\s!singlecolumn]%
	   \page_otr_command_set_vsize
	   \page_otr_command_set_hsize
	   \page
	   \endgroup}
	\protect
	
	%%%%%%%
	% LANGUAGES
	%%%%%%%
	
	%Setup English language settings:
	\setuplanguage[en][
		spacing=packed % use French spacing
	]
	
	%Setup Hebrew language settings:
	\setuplanguage[he][]
	
	%%%%%
	% FONTS
	%%%%%
	
	\definefontfeature[default][default][protrusion=pure] %allow punctuation and certain parts of letters to extend outside of the text block
	
	\definefontfeature[ebgaramond-normal][default][
		liga=yes, % standard ligatures
		dlig=yes, % ``Th'' ligature
		kern=yes, % enable kerning
		onum=yes, % use old-style numbers
		tnum=yes, % use tabular (uniform-width) numbers
		cv80=yes, %use alternate circumflex for Greek
		script=latn % Latin script
	]
	\definefontfeature[ebgaramond-header][default][
		liga=no, % disable standard ligatures
		dlig=no, % disable discretionary ligatures
		kern=no, % disable kerning (to accommodate increased letterspacing)
		onum=yes, % use old-style numbers
		tnum=yes, % use tabular (uniform-width) numbers
		script=latn % Latin script
	]
	\definefontfeature[ebgaramond-title][default][
		liga=no, % no ligatures
		kern=no, % disable kerning
		lnum=yes, % use lining numbers
		tnum=yes, % use tabular (uniform-width) numbers
		script=latn % Latin script
	]
	\definefontfeature[ebgaramond-smallcaps][ebgaramond-normal][
		smcp=yes
	]
	\definefontfeature[keteryg-normal][hebrew]
	\definefontfeature[keteryg-header][hebrew][
		kern=no % disable kerning (to accommodate increased letterspacing)
	]
	\definefontfeature[keteraramtsova-title][hebrew][
		kern=no % disable kerning (to accommodate increased letterspacing)
	]
	\definefontfeature[superscript][sups=yes] %superscript
	
	\definecharacterkerning
		[essaytitlekerning]
		[factor=0.3333,
		features=letterspacing]
		
	\definecharacterkerning
		[booktitlekerning]
		[factor=0.5,
		features=letterspacing]
		
	\definecharacterkerning
		[headerkerning]
		[factor=0.25,
		features=letterspacing]
		
	%Define a macro that uses the actual superscript font feature:
	\define[1]\textsuperscript{{\feature[+][superscript]#1}}
	
	%Use EB Garamond for English and Greek text
	\starttypescriptcollection[ebgaramond]
		\starttypescript[serif][ebgaramond]
			\definefontsynonym[Serif][file:../fonts/EB-Garamond/EBGaramond12-Regular.otf][features=ebgaramond-normal]
			\definefontsynonym[SerifItalic][file:../fonts/EB-Garamond/EBGaramond12-Italic.otf][features=ebgaramond-normal]
			\definefontsynonym[SerifBold][file:../fonts/EB-Garamond/EBGaramond-SemiBold.otf][features=ebgaramond-normal]
			\definefontsynonym[SerifBoldItalic][file:../fonts/EB-Garamond/EBGaramond-SemiBoldItalic.otf][features=ebgaramond-normal]
			\definefontsynonym[SerifCaps][Serif][features=ebgaramond-smallcaps]
			\definefontsynonym[Titling][Serif][features=ebgaramond-title] % same, but with no kerning or ligatures
		\stoptypescript
	
		\starttypescript[ebgaramond]
			\definetypeface[ebgaramond][rm][serif][ebgaramond][default]
		\stoptypescript
	\stoptypescriptcollection
	
	%Use Apparatus SIL for text-critical notation
	\starttypescriptcollection[apparatus]
		\starttypescript[serif][apparatus]
			\definefontsynonym[Serif][file:../fonts/Apparatus-SIL/AppSILR.ttf][features=default]
			\definefontsynonym[SerifItalic][file:../fonts/Apparatus-SIL/AppSILI.ttf][features=default]
			\definefontsynonym[SerifBold][file:../fonts/Apparatus-SIL/AppSILB.ttf][features=default]
			\definefontsynonym[SerifBoldItalic][file:../fonts/Apparatus-SIL/AppSILBI.ttf][features=default]
		\stoptypescript
	
		\starttypescript[apparatus]
			\definetypeface[apparatus][rm][serif][apparatus][default]
		\stoptypescript
	\stoptypescriptcollection
	
	%Use Keter YG for Hebrew text
	\starttypescriptcollection[keteryg]
		\starttypescript[serif][keteryg]
			\definefontsynonym[Serif][file:../fonts/KeterYG/KeterYG-Medium.ttf][features=keteryg-normal]
			\definefontsynonym[SerifItalic][Serif] % we don't use this
			\definefontsynonym[SerifBold][Serif] % we don't use this
			\definefontsynonym[SerifBoldItalic][Serif] % we don't use this
			\definefontsynonym[Titling][file:../fonts/KeterAramTsova/KeterAramTsova.ttf][features=keteraramtsova-title] % different titling font, with no kerning
		\stoptypescript
	
		\starttypescript[keteryg]
			\definetypeface[keteryg][rm][serif][keteryg][default]
		\stoptypescript
	\stoptypescriptcollection
	
	%Install these typescripts:
	\usetypescript[ebgaramond]
	\usetypescript[apparatus]
	\usetypescript[keteryg]
	
	% Define custom size scales for different text font sizes:
	\definebodyfontenvironment[12pt][x=10pt, text=12pt, d=24pt]
	\definebodyfontenvironment[13pt][x=11pt, text=13pt, d=30pt]
	
	%Set the main body text for the whole document (including headers and footers):
	\setupbodyfont[ebgaramond, 12pt]
	
	%Define a macro that switches to inline Hebrew text:
	\define[1]\Heb{{\textdir TRT\switchtobodyfont[keteryg]#1}}
	
	%%%%%%%
	% TEXT LAYOUT
	%%%%%%%
	
	%Setup the two-column layout for Hebrew text:
	\definepagecolumns [hebrew] [
		n=2, % number of columns
		distance=0.375in, % space between columns
		direction=reverse, % ordering of columns (RTL for Hebrew text)
		setups=hebrew:layout % use layout settings defined below
	]
	
	%Layout settings for Hebrew text:
	\startsetups[hebrew:layout]
		\switchtobodyfont[keteryg, 13pt]
		\setupalign[r2l,flushleft,nothyphenated] % Hebrew should be set right-to-left, flush left, with no hyphenation
	\stopsetups
	
	%Setup font size and leading for text:
	\setupinterlinespace[18bp] % text line spacing
	
	%Ensure that whitespace respects the grid layout:
	\setupblank[line,fixed]
	
	%Modify the layout for the itemize environment:
	\setupitemize[each][packed][width=1em]
	
	%Modify the settings for the blockquote environment:
	\setupdelimitedtext[blockquote][
		leftmargin=2em,
		rightmargin=2em,
		spacebefore=line, %add one line of space before
		spaceafter=line, %add one line of space after
		indenting=no, %don't indent the first paragraph of the blockquote
		style=\tfx % use footnote size
	]
	
	%Modify the settings for figure captions:
	\setupcaption[figure][
		way=bypart, %reset figure numbering at each part
		minwidth={\dimexpr\textwidth - 4em\relax},
		leftmargin=2em,
		rightmargin=2em,
		align={hanging, hyphenated},
		headstyle={\sc\setcharactercasing[word]}, %set heading in small caps
	]
	
	%%%%%%%%%%%
	% FOOTNOTE LAYOUT
	%%%%%%%%%%%
	
	%Setup layout for footnotes:
	\startsetups[footnotesetup]
		\setupinterlinespace[15bp] % footnote line spacing
		\switchtobodyfont[ebgaramond, 10pt] % footnote font
		\setupalign[hanging,hyphenated] % alignment of text (justified, protrusion allowed, hyphenation allowed)
	\stopsetups
	
	%Setup layout of footnote text blocks:
	\setupnote[footnote][
		rule=off, %disable line separating footnotes from text
		before={\blank[18bp]}, %enforce one line of blank space between the text and the footnote block
		textcommand=\textsuperscript, %command for typesetting the footnote number in the main text
		setups=footnotesetup %setup for footnote font, leading, and alignment
	]
	%Setup formatting of footnote mark at bottom of text:
	\setupnotation[footnote][
		way=bypart, %reset footnote numbers for each part (i.e., Essay)
		alternative=left, % align footnote symbol with edge of text
		hang=fit, % subsequent lines in the same footnote paragraph are not indented
		indenting={yes, 1em}, % but subsequent paragraphs in the same footnote are
		numbercommand=\textsuperscript % command for typesetting the footnote number in the footnote block
	]
	
	%%%%%%%%%%%%
	% APPARATUS NOTATION
	%%%%%%%%%%%%
	
	%Setup a parent class of footnotes for all apparatus entries:
	\definenote[app]
	\setupnote[app][
		rule=off, %disable line separating the apparatus from the text
		before={\blank[18bp]}, %enforce one line of blank space between the text and the apparatus
		textcommand=, %disable the default notation for the footnote symbol in the text; this will redefined for each footnote
		setups=footnotesetup %setup for footnote font, leading, and alignment
	]
	\setupnotation[app][
		numbercommand=, %disable the default notation for the footnote number; this will redefined for each footnote
		counter=, %disable the default counter for the footnote number; this will redefined for each footnote
		alternative=left, %align footnote symbol with edge of text (use right for RTL)
		hang=fit, %multi-line footnotes are not indented
	]
	
	%Define a variable containing the current chapter-verse reference covered in the apparatus:
	\setevariables[app][chapter=0,verse=0]
	
	%Define macro for adding a chapter-verse reference in the apparatus if it differs from the last chapter-verse reference in the apparatus:
	\define\SetAppRef{
		%Check if the current chapter reference matches the most recent chapter reference in the apparatus:
		\doifelse{\getvariable{text}{chapter}}{\getvariable{app}{chapter}}{%
			%If it does, then check if the verse reference matches:
			\doifelse{\getvariable{text}{verse}}{\getvariable{app}{verse}}{%
				%If it does, then do nothing:
				\nospace%
			}{%
				%If it does not, then update the latest verse reference and typeset the reference:
				\setxvariables[app][verse=\getvariable{text}{verse}]%
				{\switchtobodyfont[ebgaramond, 12pt]\tfx\textdir TLT{\bf\getvariable{text}{chapter}\,:\,\getvariable{text}{verse}}}\nobreak\hspace[medium]%
			}%
		}{%
			%If it does not, then update the latest chapter and verse references and typeset the reference:
			\setxvariables[app][chapter=\getvariable{text}{chapter},verse=\getvariable{text}{verse}]%
			{\switchtobodyfont[ebgaramond, 12pt]\tfx\textdir TLT{\bf\getvariable{text}{chapter}\,:\,\getvariable{text}{verse}}}\nobreak\hspace[medium]%
		}%
	}
	
	%Define counters for different variation types:
	\definecounter[sub]
	\definecounter[add]
	\definecounter[omit]
	\definecounter[trans]
	\setcounter[sub] [0]
	\setcounter[add] [0]
	\setcounter[omit] [0]
	\setcounter[trans] [0]
	
	%Define macros for typesetting apparatus marks:
	\define[1]\StartSubMark{{\switchtobodyfont[apparatus, 12pt]⸃}\doifnot{#1}{1}{{\switchtobodyfont[ebgaramond, 12pt]\textsuperscript{#1}}}} %reverse symbol for RTL
	\define\StopSubMark{{\switchtobodyfont[apparatus, 12pt]⸂}} %reverse symbol for RTL
	\define[1]\AddMark{{\switchtobodyfont[apparatus, 12pt]⸆}\doifnot{#1}{1}{{\switchtobodyfont[ebgaramond, 12pt]\textsuperscript{#1}}}}
	\define[1]\StartOmitMark{{\switchtobodyfont[apparatus, 12pt]⸋}\doifnot{#1}{1}{{\switchtobodyfont[ebgaramond, 12pt]\textsuperscript{#1}}}}
	\define\StopOmitMark{{\switchtobodyfont[apparatus, 12pt]⸌}} %should reverse symbol for RTL, but Apparatus SIL doesn't include U2E0D
	\define[1]\StartTransMark{{\switchtobodyfont[apparatus, 12pt]⸊}\doifnot{#1}{1}{{\switchtobodyfont[ebgaramond, 12pt]\textsuperscript{#1}}}} %reverse symbol for RTL
	\define\StopTransMark{{\switchtobodyfont[apparatus, 12pt]⸉}} %reverse symbol for RTL
	
	%Define macros for apparatus entries:
	\define[2]\Reading{ %arg 1 is reading text, arg 2 is witness list
		\doifemptyelse{#1}{%
			{\switchtobodyfont[ebgaramond, 10pt]\textdir TLT –}\nospace\nobreak\ {\switchtobodyfont[ebgaramond, 10pt]\textdir TLT#2}\nobreak\ %represent the omission with an en-dash 
		}{%
			{\switchtobodyfont[keteryg, 11pt]\textdir TRT #1}\nospace\nobreak\ {\switchtobodyfont[ebgaramond, 10pt]\textdir TLT#2}\nobreak\ %set the reading in Hebrew
		}%
	} 
	\define\PrimaryReadingSep{{\switchtobodyfont[ebgaramond, 10pt][}\nobreak\,} %reverse symbol for RTL
	\define\SecondaryReadingSep{{\switchtobodyfont[ebgaramond, 10pt]¦}\nobreak\,}
	
	%Define a macro for typesetting an apparatus:
	\define[3]\App{% arg 1 is the type of variation, arg 2 is the lemma text, arg 3 is the variant readings
		%Define the footnote symbol based on the type:
		\doif{#1}{substitution}{%
			%Update the counter:
			\incrementcounter[sub]%
			%Typeset the marking in the text:
			\StartSubMark{\rawcountervalue[sub]}\nobreak\,%
			%Then start the apparatus note:
			\startapp%
				%Typeset the marking in the apparatus, preceded by the chapter-verse reference, if needed, and followed by the variant readings:
				\SetAppRef\StartSubMark{\rawcountervalue[sub]}\nobreak\,#3%
			\stopapp%
			%Typeset the lemma in the text, followed by the closing substitution mark:
			\nobreak#2\nobreak\,\StopSubMark%
		}%
		\doif{#1}{vocalic substantive}{%
			%Update the counter:
			\incrementcounter[sub]%
			%Typeset the marking in the text:
			\StartSubMark{\rawcountervalue[sub]}\nobreak\,%
			%Then start the apparatus note:
			\startapp%
				%Typeset the marking in the apparatus, preceded by the chapter-verse reference, if needed, and followed by the variant readings:
				\SetAppRef\StartSubMark{\rawcountervalue[sub]}\nobreak\,#3%
			\stopapp%
			%Typeset the lemma in the text, followed by the closing substitution mark:
			\nobreak#2\nobreak\,\StopSubMark%
		}%
		\doif{#1}{addition}{%
			%Update the counter:
			\incrementcounter[add]%
			%Typeset the marking in the text:
			\AddMark{\rawcountervalue[add]}\nobreak\,%
			%Then start the apparatus note:
			\startapp%
				%Typeset the marking in the apparatus, preceded by the chapter-verse reference, if needed, and followed by the variant readings:
				\SetAppRef\AddMark{\rawcountervalue[add]}\nobreak\,#3%
			\stopapp%
		}%
		\doif{#1}{omission}{%
			%Update the counter:
			\incrementcounter[omit]%
			%Typeset the marking in the text:
			\StartOmitMark{\rawcountervalue[omit]}\nobreak\,%
			\startapp%
				%Typeset the marking in the apparatus, preceded by the chapter-verse reference, if needed, and followed by the variant readings:
				\SetAppRef\StartOmitMark{\rawcountervalue[omit]}\nobreak\,#3%
			\stopapp%
			%Typeset the lemma in the text, followed by the closing substitution mark:
			\nobreak#2\nobreak\,\StopOmitMark%
		}%
		\doif{#1}{transposition}{%
			%Update the counter:
			\incrementcounter[trans]%
			%Typeset the marking in the text:
			\StartTransMark{\rawcountervalue[trans]}\nobreak\,%
			%Then start the apparatus note:
			\startapp%
				%Typeset the marking in the apparatus, preceded by the chapter-verse reference, if needed, and followed by the variant readings:
				\SetAppRef\StartTransMark{\rawcountervalue[trans]}\nobreak\,#3%
			\stopapp%
			%Typeset the lemma in the text, followed by the closing substitution mark:
			\nobreak#2\nobreak\,\StopTransMark%
		}%
	}
	
	%%%%%%%%%
	% TEXT DIVISIONS
	%%%%%%%%%
	
	%Font command to be used for section headings:
	\definefont[sectionTitleFont][Serif at 12pt]
	
	%Font command to be used for Essay headings:
	\definefont[EssayTitleFont][Titling at 24pt][line=36bp]
	
	%Font command to be used for Book headings
	\definefont[BookTitleFont][Titling at 30pt][line=36bp]
	
	%Enable section numbering and blank odd page break in front and back matter (they are disabled by default):
	\setupsectionblock[frontpart][number=yes,page=blankpagebreak]
	\setupsectionblock[bodypart][number=yes,page=blankpagebreak]
	\setupsectionblock[backpart][number=yes,page=blankpagebreak]
	
	%Redefine the part heading:
	\setuphead[part][
		placehead=yes,%print the heading (necessary for the part heading, which isn't normally printed)
		number=no,%do not add a number to this heading
		incrementnumber=yes, %but do keep track of it for the ToC
		page=blankpagebreak,%use an odd page break with no header or footer
		header=empty,%disable headers for this page
		footer=empty,%disable footers for this page
		align={flushleft, nothyphenated},%use English alignment settings, adjusted for titling
		style=EssayTitleFont, %use the titling font
		textstyle={\setcharacterkerning[essaytitlekerning]\setcharactercasing[WORD]}, % use extra letterspacing and set in all caps
		before=, %add nothing before
		after={\blank[line]},%add a blank line after
		indentnext=no%do not indent the paragraph that follows
	]
	
	%Redefine the section heading:
	\setuphead[section][
		placehead=yes,%print the heading
		number=yes,% include the number
		sectionsegments=section:subsection, % section numbers should be printed first, followed by subsection number (no part or chapter numbers)
		header=nomarking,%allow headers for this page
		footer=nomarking,%allow footers for this page
		align={flushleft, nothyphenated},%align flush-left and do not hyphenate
		style=sectionTitleFont,
		numberstyle={\rm}, %set number in roman at the size of the main text
		textstyle={\sc\setcharactercasing[word]}, %set title in small caps at the size of the main text
		before={\blank[line]\testpage[3]}, %add two blank lines before, and if there is not room for three lines after the title, then force a page break
		after={\blank[line]},%add a blank line after
		indentnext=no%do not indent the paragraph that follows
	]
	
	%Redefine the subsection heading:
	\setuphead[subsection][
		placehead=yes,%print the heading
		number=yes,% include the number
		header=nomarking,%allow headers for this page
		footer=nomarking,%allow footers for this page
		align={flushleft, nothyphenated},%align flush-left and do not hyphenate
		style=sectionTitleFont,
		numberstyle={\rm}, %set number in roman at the size of the main text
		textstyle={\it}, %set title in italics at the size of the main text
		before={\blank[line]\testpage[3]}, %add a blank line before, and if there is not room for three lines after the title, then force a page break
		after={\blank[line]},%add a blank line after
		indentnext=no%do not indent the paragraph that follows
	]
	
	%Define a new Title heading at the level of a part:
	\definehead[Title][part]
	\setuphead[Title][
		placehead=yes,%print the heading (necessary for the part heading, which isn't normally printed)
		number=no,%do not add a number to this heading
		incrementnumber=no, %do not keep track of it for the ToC
		page=blankpagebreak,%use an odd page break with no header or footer
		header=empty,%disable headers for this page
		footer=empty,%disable footers for this page
		align={middle},%align in the center
		textstyle={\setcharacterkerning[essaytitlekerning]\setcharactercasing[WORD]}, % use extra letterspacing and set in all caps
		before={\phantom{*}\blank[5*line]},%add five blank lines before
		after={}%no extra space after
	]
	
	%Define a new Info heading at the level of a part:
	\definehead[Info][part]
	\setuphead[Info][
		placehead=no,%don't print the heading (there shouldn't be one anyway)
		number=no,%do not add a number to this heading
		incrementnumber=no, %do not keep track of it for the ToC
		page=yes,%force a (single) page breal before this
		header=empty,%disable headers for this page
		footer=empty,%disable footers for this page
		before={},%no space before
		after={}%no space after
	]
	
	%Define a new Contents heading at the level of a part:
	\definehead[Contents][part]
	\setuphead[Contents][
		placehead=yes,%print the heading (necessary for the part heading, which isn't normally printed)
		number=no,%do not add a number to this heading
		incrementnumber=no, %do not keep track of it for the ToC
		page=blankpagebreak,%use an odd page break with no header or footer
		header=empty,%disable headers for this page
		footer=empty,%disable footers for this page
		before={},%no space before
		after={}%no space after
	]
	
	%Define a new Essay heading at the level of a part:
	\definehead[Essay][part]
	\setuphead[Essay][
		placehead=yes,%print the heading (necessary for the part heading, which isn't normally printed)
		number=no,%do not add a number to this heading
		incrementnumber=yes, %but do keep track of it for the ToC
		page=blankpagebreak,%use an odd page break with no header or footer
		header=empty,%disable headers for this page
		footer=empty,%disable footers for this page
		align={flushleft, nothyphenated},%use English alignment settings, adjusted for titling
		style=EssayTitleFont, %use the titling font
		textstyle={\setcharacterkerning[essaytitlekerning]\setcharactercasing[WORD]}, % use extra letterspacing and set in all caps
		before={\phantom{*}\blank[5*line]},%add five blank lines before
		after={\page[blankpagebreak]\noindentation}%add a double page break
	]
	
	%Define a new Book heading at the level of a part:
	\definehead[Book][part]
	\setuphead[Book][
		placehead=yes,%print the heading (necessary for the part heading, which isn't normally printed)
		number=no,%do not add a number to this heading
		incrementnumber=yes, %but do keep track of it for the ToC
		header=empty,%disable headers for this page
		footer=empty,%disable footers for this page
		align={r2l, flushright, nothyphenated},%use Hebrew alignment settings, but make flush right
		style=BookTitleFont, %use the titling font
		textstyle={\setcharacterkerning[booktitlekerning]}, % use extra letterspacing
		deeptextcommand=\ReplaceHeaderSpaces,
		before={\phantom{*}\blank[5*line]},%add five blank lines before
		after={\page[blankpagebreak]\noindentation}%add a double page break
	]

	%Define a new BookCollection heading at the level of a part:
	\definehead[BookCollection][part]
	\setuphead[BookCollection][
		placehead=yes,%print the heading (necessary for the part heading, which isn't normally printed)
		number=no,%do not add a number to this heading
		incrementnumber=yes, %but do keep track of it for the ToC
		header=empty,%disable headers for this page
		footer=empty,%disable footers for this page
		align={r2l, flushright, nothyphenated},%use Hebrew alignment settings, but make flush right
		style=BookTitleFont, %use the titling font
		textstyle={\setcharacterkerning[booktitlekerning]}, % use extra letterspacing
		deeptextcommand=\ReplaceHeaderSpaces,
		before=, %add nothing before
		after={\page[blankpagebreak]\noindentation}%add a double page break
	]
	
	%Define a Subbook heading at the level of a part:
	\definehead[Subbook][part]
	\setuphead[Subbook][
		placehead=hidden,%do not typeset this heading
		number=no,%do not add a number to this heading
		incrementnumber=yes, %but do keep track of it for the ToC
		after=,%add nothing after
	]
	
	%The use of placehead=hidden above is necessary to facilitate uninterrupted transitions between subbooks,
	%but it makes the Subbooks ``invisible'' to tabulations made for the Tabel of Contents.
	%The ConTeXt wiki (https://wiki.contextgarden.net/Titles) recommends the following command to resolve this:
	\setuptexttexts[{\placerawheaddata[Subbook]}]
	
	%Define custom chapter and verse markings to be used in the header:
	\definemarking[Chapter]
	\definemarking[Verse]
	
	%Define custom chapter and verse variables to be used in the apparatus:
	\setxvariables[text][chapter=,verse=]
	
	%Define macro for starting a new Chapter:
	\define[1]\Chapter{%
		%Update the chapter title and reset the verse title (the chapter will be typeset when the verse is):
		\setxvariables[text][chapter=#1,verse=0]%
		\marking[Chapter]{#1}%
	}
	%Define macro for marking a new Chapter in a variant reading (the chapter will be typeset when the verse is):
	\define[1]\RdgChapter{%
		%Update the chapter title and reset the verse title:
		\setxvariables[rdg][chapter=#1,verse=0]%
	}
	
	%Define macro for starting a new Verse:
	\define[1]\Verse{%
		%Check if the verse variable has been reset:
		\doifelse{\getvariable{text}{verse}}{0}{%
			%If it has, then typeset both the chapter and the verse:
			\marking[Verse]{#1}{\switchtobodyfont[ebgaramond, 12pt]\textdir TLT\bf\nobreak\  \getvariable{text}{chapter}\nobreak\,:\nobreak\,#1}\nobreak\ %
		}{%
			%Otherwise, just typeset the verse:
			\marking[Verse]{#1}{\switchtobodyfont[ebgaramond, 12pt]\textdir TLT\bf\nobreak\ #1}\nobreak\ %
		}%
		%Update the verse variable:
		\setxvariables[text][verse=#1]%
		%Reset the textual variation type counters:
		\setcounter[sub][0]%
		\setcounter[add][0]%
		\setcounter[omit][0]%
		\setcounter[trans][0]%
	}
	
	%Define macro for marking a new Verse in a variant reading:
	\define[1]\RdgVerse{%
		%Check if the verse variable has been reset:
		\doifelse{\getvariable{rdg}{verse}}{0}{%
			%If it has, then typeset both the chapter and the verse:
			{\switchtobodyfont[ebgaramond, 10pt]\textdir TLT\bf \getvariable{rdg}{chapter}\nobreak\,:\nobreak\,#1}\nobreak\ %
		}{%
			%Otherwise, just typeset the verse:
			\marking[Verse]{#1}{\switchtobodyfont[ebgaramond, 10pt]\textdir TLT\bf #1}\nobreak\ %
		}%
		%Update the verse variable:
		\setxvariables[rdg][verse=#1]%
	}
	
	%Define macro for closed section break:
	\definehspace[closedsectionspace][3em]
	\define\ClosedSection{%
		\nospace\hspace[none]\phantom{\hspace[closedsectionspace]}\nobreak%eat up any preceding space, add a space of zero width (to allow this to break from the preceding word), and then add a long non-breaking space
	}
	
	%Define macro for closed section break in a variant reading:
	\define\RdgClosedSection{} % Empty because we've decided this isn't necessary; but define it if you want a printed representation of a closed section in the apparatus
	
	%Define macro for open section break:	
	\define\OpenSection{%
		\blank[halfline, samepage]%non-breaking to ensure that no column begins with the open section symbol
		\startalignment[middle]׆\stopalignment %open section symbol, centered
		\blank[halfline]%
		\testcolumn[1]% if there is not room for the current line of text and one more line, then force a column break
	}
	
	%Define macro for open section break in a variant reading:
	\define\RdgOpenSection{} % Empty because we've decided this isn't necessary; but define it if you want a printed representation of an open section in the apparatus

	%%%%%%
	% MARGINS
	%%%%%%

	%Define macro for getting a reference range:
	\define\RefRange{%
		%Check if the first chapter matches the last chapter on the page:
		\doifsamestringelse{\fetchmarking[Chapter][1][top]}{\fetchmarking[Chapter][2][bottom]}{%
			%If the chapters match, then check if the first verse matches the last verse on the page:
			\doifsamestringelse{\fetchmarking[Verse][1][top]}{\fetchmarking[Verse][2][bottom]}{%
				%If the verses match, then the page consists of a single verse; use its reference:
				\getmarking[Chapter][1][top]\,:\,\getmarking[Verse][1][top]%
			}{%
				%If the verses do not match, then use one chapter and the verse range:
				\getmarking[Chapter][1][top]\,:\,\getmarking[Verse][1][top]\,--\,\getmarking[Verse][2][bottom]%
			}%
		}{%
			%If the chapters do not match, then use the entire reference range:
			\getmarking[Chapter][1][top]\,:\,\getmarking[Verse][1][top]\,--\,\getmarking[Chapter][2][bottom]\,:\,\getmarking[Verse][2][bottom]%
		}%
	}
	
	%Define lua functions to replace single spaces with longer spaces:
	\startluacode
		userdata = userdata or {}
	
		function userdata.replaceSpaceWithEnSpace(str)
			local rep = {
				[1] = { " ", " " },
			}
			context(lpeg.replacer(rep):match(str))
		end
	\stopluacode
	%Define macros that uses these functions:
	\define[1]\ReplaceHeaderSpaces{\ctxlua{userdata.replaceSpaceWithEnSpace([==[#1]==])}}
	
	%%%%%%%%%%%
	% TABLE OF CONTENTS
	%%%%%%%%%%%
	
	%Setup the table of contents:
	\setupcombinedlist[content][
		list={part,Essay,Book,BookCollection,Subbook}, %only list titles under these headings
		alternative=c, %put dots between titles and page numbers
	]
	\setuplist[part][margin=0em]
	\setuplist[Essay][margin=0em]
	\setuplist[Book][margin=0em, textcommand=\Heb,] %set Hebrew book names in Hebrew
	\setuplist[BookCollection][margin=0em, textcommand=\Heb, before={\testpage[5]\blank}] %set Hebrew book colelction names in Hebrew, ensuring that there is sufficient space below them in the ToC
	\setuplist[Subbook][margin=1em, textcommand=\Heb,] %set Hebrew subbook names in Hebrew, indented one level
	
	%Define an extra feature that will add a page break before a given ToC entry:
	\definelistextra[page][before=\page]
	
	%%%%%%%%%
	% ABBREVIATIONS
	%%%%%%%%%
	
	%Setup abbreviation settings:
	\setupsynonyms[abbreviation][textstyle=normal, synonymstyle=normal] % don't force capitalization
	
	%Initialize abbreviations used in this book:
	\abbreviation{AIL}{Ancient Israel and Its Literature}
	\abbreviation{ANEM}{Ancient Near East Monographs}
	\abbreviation{ABRL}{Anchor Yale Bible Reference Library}
	\abbreviation[BHS]{\italic{BHS}}{\italic{Biblica Hebraica Stuttgartensia}. 5th ed. Stuttgart: Deutsche Bibelgesellschaft, 1997}
	\abbreviation[BHQ]{\italic{BHQ}}{\italic{Biblica Hebraica Quinta}. 20 vols. Stuttgart: Deutsche Bibelgesellschaft,\\2004–}
	\abbreviation{BRLA}{Brill Reference Library of Judaism}
	\abbreviation{CBET}{Contributions to Biblical Exegesis and Theology}
	\abbreviation{FAT}{Forschungen zum Alten Testament}
	\abbreviation{G}{The Hebrew \italic{Vorlage} underlying the Greek versions of the \HB{}}
	\abbreviation[HALOT]{\italic{HALOT}}{\italic{The Hebrew and Aramaic Lexicon of the Old Testament}. Ludwig Koehler and Walter Baumgartner. Translated and edited under the supervision of Mervyn E. J. Richardson. 2 vols. Leiden: Brill, 2001}
	\abbreviation{HB}{Hebrew Bible}
	\abbreviation{HSM}{Harvard Semitic Monographs}
	\abbreviation[JAOS]{\italic{JAOS}}{\italic{Journal of the American Oriental Society}}
	\abbreviation[Leningrad]{L}{Leningrad Codex (National Library of Russia Firkovich B19A)\\(in the apparatus, refers to the reading in the WLC transcription)}
	\abbreviation{LSAWS}{Linguistic Studies in Ancient West Semitic}
	\abbreviation{LXX}{Septuagint}
	\abbreviation{M}{The Hebrew archetype of the \MT{}}
	\abbreviation{MS}{manuscript}
	\abbreviation{MPIL}{Monographs of the Peshitta Institute Leiden}
	\abbreviation{MRTS}{Medieval and Renaissance Texts and Studies}
	\abbreviation{MS}{manuscript}
	\abbreviation{MSS}{manuscripts}
	\abbreviation{MT}{Masoretic Text}
	\abbreviation{NAC}{New American Commentary}
	\abbreviation{NICOT}{New International Commentary on the Old Testament}
	\abbreviation{OG}{Old Greek}
	\abbreviation{SANER}{Studies in Ancient Near Eastern Records}
	\abbreviation{SBLDS}{Society of Biblical Literature Dissertation Series}
	\abbreviation{SBLSCS}{SBL Septuagint and Cognate Studies}
	\abbreviation{SR}{Siglum indicating readings adopted in this edition}
	\abbreviation{SSLL}{Studies in Semitic Languages and Linguistics}
	\abbreviation{STDJ}{Studies on the Texts of the Desert of Judah}
	\abbreviation[TC]{\italic{TC}}{\italic{TC: A Journal of Biblical Textual Criticism}}
	\abbreviation{TCST}{Text-Critical Studies}
	\abbreviation[THB]{\italic{THB}}{\italic{Textual History of the Bible}. Edited by Armin Lange. 3 vols in 10. Leiden: Brill, 2016–}
	\abbreviation{THBSup}{Supplements to \italic{Textual History of the Bible}}
	\abbreviation{TOTC}{Tyndale Old Testament Commentaries}
	\abbreviation[VT]{\italic{VT}}{\italic{Vetus Testamentum}}
	\abbreviation{VTSup}{Supplements to \italic{Vetus Testamentum}}
	\abbreviation{UXLC}{Unicode/XML Leningrad Codex}
	
	%%%%%%%%
	% BIBLIOGRAPHY
	%%%%%%%%
	
	%ConTeXt does not support SBL style (yet), so setup manual bibliography settings:
	\def\dostartbibitem[#1][#2]{%
		\doifsomethingelse{#2}{%
			\startBibItem[reference={#1},title={#2}]%
		}%
	    	{%
	    		\startBibItem[reference={#1},title={#1}]%
		}%
	}%
	\def\startbibitem{\dodoubleempty\dostartbibitem}
	\def\stopbibitem{\stopBibItem}

	\definedescription[BibItem][
		width=broad,
		margin=1em,
		indenting={no},
		indentnext=no,
		alternative=hanging,
		hang=1,
		headcommand=\gobbleoneargument,
		align=flushleft,
		before={\testpage[4]\blank}
	]

	%Steup the line for repeated authors:
	\def\bibitemrule{\noindentation\vrule height3pt width6em depth-2.5pt\thinspace}
	
	%%%%%%%%%%%%%%
	% CONDITIONAL FORMATTING
	%%%%%%%%%%%%%%
	
	%Front matter:
	\startsectionblockenvironment[frontpart]
		%Switch to English language:
		\language[en]
		%Setup page number conversion:
		\setupuserpagenumber[numberconversion=romannumerals] %Roman numerals
		\setuplist[chapter][pageconversionset=pagenumber]
		\setuppagenumber[number=1] %restart page numbering
		%Change the font of the text (but not the headers and footers):
		\switchtobodyfont[ebgaramond, 12pt]
		%Setup text direction:
		\textdir TLT %left-to-right
		%Setup alignment for the text:
		\setupalign[hanging,hyphenated] %justified and hyphenated, with protrusion allowed
		%Setup text paragraph indentation:
		\setupindenting[yes, 1em] %enable indentation with a 1-em indent
		%Setup layout for footnotes:
		\startsetups[footnotesetup]
			\setupinterlinespace[15bp] % footnote line spacing
			\switchtobodyfont[ebgaramond, 10pt] % footnote font
			\setupalign[hanging,hyphenated] % alignment of text (justified, protrusion allowed, hyphenation allowed)
		\stopsetups
		%Setup header (need to use \setupheadertexts because of font switches)
		\setupheadertexts[\hfill{\switchtobodyfont[ebgaramond, 12pt]\feature[+][ebgaramond-header]\setcharacterkerning[headerkerning]\textdir TLT\sc\word{\namedstructurevariable{Essay}{title}}\hfill}][][][\hfill{\switchtobodyfont[ebgaramond, 12pt]\feature[+][ebgaramond-header]\setcharacterkerning[headerkerning]\textdir TLT\sc\word{\namedstructurevariable{Essay}{title}}}\hfill] %even left, even right, odd left, odd right
	\stopsectionblockenvironment
	%Body matter:
	\startsectionblockenvironment[bodypart]
		%Switch to Hebrew language:
		\language[he]
		%Setup page number conversion:
		\setuppagenumber[number=1] %restart page numbering
		\setupuserpagenumber[numberconversion=numbers] %Arabic numerals
		%Change the font of the text (but not the headers and footers):
		\switchtobodyfont[keteryg, 13pt]
		%Setup text direction:
		\textdir TRT %right-to-left
		%Setup alignment for the text:
		\setupalign[r2l,flushleft,nothyphenated] %right-to-left, flush left, with no hyphenation
		%Setup text paragraph indentation:
		\setupindenting[no] %disable indentation
		%Setup layout for footnotes:
		\startsetups[footnotesetup]
			\setupinterlinespace[15bp] % footnote line spacing
			\switchtobodyfont[keteryg, 11pt] % footnote font
			\setupalign[r2l, flushleft,nothyphenated] % alignment of text (right-to-left, flush left, with no hyphenation)
		\stopsetups
		%Setup header (need to use \setupheadertexts because of font switches)
		\setupheadertexts[\rlap{\switchtobodyfont[ebgaramond, 12pt]\textdir TLT\RefRange}\hfill {\switchtobodyfont[keteryg, 13pt]\feature[+][keteryg-header]\setcharacterkerning[headerkerning]\textdir TRT\ReplaceHeaderSpaces{\namedstructurevariable{part}{title}}} \hfill][][][\hfill {\switchtobodyfont[keteryg, 13pt]\feature[+][keteryg-header]\setcharacterkerning[headerkerning]\textdir TRT\ReplaceHeaderSpaces{\namedstructurevariable{part}{title}}} \hfill \llap{\switchtobodyfont[ebgaramond, 12pt]\textdir TLT\RefRange}] %even left, even right, odd left, odd right
	\stopsectionblockenvironment
	%Back matter:
	\startsectionblockenvironment[backpart]
		%Switch to English language:
		\language[en]
		%Setup page number conversion:
		\setupuserpagenumber[numberconversion=numbers] %Arabic numerals
		%Change the font of the text (but not the headers and footers):
		\switchtobodyfont[ebgaramond, 12pt]
		%Setup text direction:
		\textdir TLT %left-to-right
		%Setup alignment for the text:
		\setupalign[hanging,hyphenated] %justified and hyphenated, with protrusion allowed
		%Setup text paragraph indentation:
		\setupindenting[yes, 1em] %enable indentation with a 1-em indent
		%Setup layout for footnotes:
		\startsetups[footnotesetup]
			\setupinterlinespace[15bp] % footnote line spacing
			\switchtobodyfont[ebgaramond, 10pt] % footnote font
			\setupalign[hanging,hyphenated] % alignment of text (justified, protrusion allowed, hyphenation allowed)
		\stopsetups
		%Setup header (need to use \setupheadertexts because of font switches)
		\setupheadertexts[\hfill{\switchtobodyfont[ebgaramond, 12pt]\feature[+][ebgaramond-header]\setcharacterkerning[headerkerning]\textdir TLT\sc\word{\namedstructurevariable{part}{title}}\hfill}][][][\hfill{\switchtobodyfont[ebgaramond, 12pt]\feature[+][ebgaramond-header]\setcharacterkerning[headerkerning]\textdir TLT\sc\word{\namedstructurevariable{part}{title}}}\hfill] %even left, even right, odd left, odd right
	\stopsectionblockenvironment
	
\stopenvironment